<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sign up — Allegations of Bribery</title>
  <link rel="icon" href="./favicon.ico" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="./css/styles.css" />

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { panel: "#111827", panel2: "#0b0e13", stroke: "#1f2933", page: "#0f1216" }
        }
      }
    };
  </script>
</head>

  <body class="bg-page text-slate-200 antialiased">
  <div id="siteHeader"></div>

  <main class="mx-auto max-w-6xl px-4 py-6">
    <section class="card narrow">
      <h2>Sign up</h2>

      <label class="label" for="displayName">Display name</label>
      <input id="displayName" class="input" type="text" placeholder="Display Name" />

      <label class="label" for="email">Email</label>
      <input id="email" class="input" type="email" autocomplete="email" placeholder="you@example.com" />

      <label class="label" for="password">Password</label>
      <input id="password" class="input" type="password" autocomplete="new-password" placeholder="••••••••" />

      <div class="legal-consent">
        <label class="checkrow">
          <input id="agreeTerms" type="checkbox" />
          <span>I agree to the <a href="./terms.html" target="_blank" rel="noopener">Legal Disclaimer and Terms of Use</a>.</span>
        </label>
        <label class="checkrow">
          <input id="agreePrivacy" type="checkbox" />
          <span>I have read the <a href="./privacy.html" target="_blank" rel="noopener">Privacy Statement</a>.</span>
        </label>
        <p class="muted small">You must check both boxes before you can create an account.</p>
      </div>

      <div class="row gap">
        <button id="signupBtn" class="btn" type="button">Create account</button>
        <a class="btn ghost" href="./login.html">Already have an account</a>
        <button id="resendBtn" class="btn ghost" type="button" style="display:none;">Resend confirmation email</button>
      </div>

      <!-- <p class="muted">
        Note: New accounts are not approved to publish until you mark them approved in Supabase.
      </p> -->

      <p id="msg" class="muted" aria-live="polite"></p>
    </section>
  </main>

  <!-- Normalize auth UI toggling (same pattern as index/forum) -->
  <script type="module">
    import initShell from "./js/shell.js";
    await initShell();
  </script>
  <script type="module">
    import { wireAuthButtons, signUp, resendSignupEmail } from "./js/auth.js";

    // 1) Toggle auth UI in header
    wireAuthButtons();

    // 2) Existing signup logic (unchanged)
    const displayName = document.getElementById("displayName");
    const email = document.getElementById("email");
    const password = document.getElementById("password");
    const msg = document.getElementById("msg");

    const agreeTerms = document.getElementById("agreeTerms");
    const agreePrivacy = document.getElementById("agreePrivacy");
    const signupBtn = document.getElementById("signupBtn");
    const resendBtn = document.getElementById("resendBtn");

    function syncConsentState() {
      const ok = agreeTerms.checked && agreePrivacy.checked;
      signupBtn.disabled = !ok;
      signupBtn.classList.toggle("disabled", !ok);
    }

    agreeTerms.addEventListener("change", syncConsentState);
    agreePrivacy.addEventListener("change", syncConsentState);
    syncConsentState();

    signupBtn.addEventListener("click", async () => {
      try {
        msg.textContent = "Creating account...";

        if (!(agreeTerms.checked && agreePrivacy.checked)) {
          msg.textContent = "You must agree to the Terms and Privacy Statement before creating an account.";
          return;
        }

        const res = await signUp(
          (email.value || "").trim(),
          password.value || "",
          (displayName.value || "").trim(),
          { termsAccepted: true, privacyAccepted: true }
        );

        if (!res.ok) {
          msg.textContent = res.error;
          return;
        }

        if (res.needsEmailConfirm) {
          msg.textContent = "Account created. Check your email for the confirmation link.";
          resendBtn.style.display = "inline-flex";
          return;
        }

        msg.textContent = "Account created and signed in.";
        window.location.href = "./index.html";
      } catch (e) {
        msg.textContent = `Signup failed: ${String(e)}`;
        console.error(e);
      }
    });

    resendBtn.addEventListener("click", async () => {
      msg.textContent = "Resending confirmation email...";
      const r = await resendSignupEmail((email.value || "").trim());
      msg.textContent = r.ok ? "Confirmation email resent. Check inbox/spam." : r.error;
    });
  </script>
</body>
</html>